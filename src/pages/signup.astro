---
import Layout from "../layouts/Layout.astro";
import pb from "../utils/pb";
import { Collections } from "../utils/pocketbase-types";

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const username = formData.get("username")?.toString() || "";
    const email = formData.get("email")?.toString() || "";
    const password = formData.get("password")?.toString() || "";
    const avatar = formData.get("avatar") as File;

    if (username.length >= 4 && password.length >= 6 && email.includes("@")) {
      const data = {
        username: username,
        email: email,
        password: password,
        passwordConfirm: password,
      };

      const record = await pb.collection(Collections.Users).create(data);
      
      if (avatar && avatar.size > 0) {
        const formDataWithAvatar = new FormData();
        formDataWithAvatar.append("avatar", avatar);
        await pb.collection(Collections.Users).update(record.id, formDataWithAvatar);
      }
      
      console.log("Nouvel utilisateur créé:", record);
      return Astro.redirect("/login");
    }
  } catch (error: any) {
    console.error("Erreur lors de l'inscription:", error);
  }
}
---

<Layout title="Sign Up">
  <div class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen py-12 px-4">
    <div class="max-w-2xl mx-auto">
      
      <div class="text-center mb-8">
        <div class="inline-block bg-blue-600 text-white rounded-full p-4 mb-4">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Créer un compte
        </h1>
        <p class="text-gray-600">
          Rejoignez-nous en quelques clics
        </p>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-8">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
          
          <div class="flex flex-col items-center pb-6 border-b border-gray-200">
            <div class="mb-4">
              <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden" id="preview-container">
                <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <img id="preview-image" class="w-full h-full object-cover hidden" alt="Preview" />
              </div>
            </div>
            <label for="avatar" class="cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-600 font-medium py-2 px-4 rounded-lg transition inline-flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              Choisir une photo
            </label>
            <input
              type="file"
              name="avatar"
              id="avatar"
              accept="image/*"
              class="hidden"
            />
            <p class="text-xs text-gray-500 mt-2">JPG, PNG ou GIF (max 5MB)</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="md:col-span-2">
              <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">
                Nom d'utilisateur *
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
                <input
                  type="text"
                  name="username"
                  id="username"
                  class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="john_doe"
                  required
                  minlength="4"
                />
              </div>
              <p class="text-xs text-gray-500 mt-1.5">Minimum 4 caractères</p>
            </div>

            <div class="md:col-span-2">
              <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                Adresse email *
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <input
                  type="email"
                  name="email"
                  id="email"
                  class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="john@exemple.com"
                  required
                />
              </div>
            </div>

            <div class="md:col-span-2">
              <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                Mot de passe *
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                </div>
                <input
                  type="password"
                  name="password"
                  id="password"
                  class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="••••••••"
                  required
                  minlength="6"
                />
              </div>
              <p class="text-xs text-gray-500 mt-1.5">Minimum 8 caractères</p>
            </div>
          </div>

          <div class="pt-4">
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3.5 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5"
            >
              Créer mon compte
            </button>
          </div>
        </form>

        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
          <p class="text-sm text-gray-600">
            Vous avez déjà un compte ? 
            <a href="/login" class="text-blue-600 hover:text-blue-700 font-semibold hover:underline ml-1">
              Se connecter
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>

    const avatarInput = document.getElementById('avatar') as HTMLInputElement;
    const previewImage = document.getElementById('preview-image') as HTMLImageElement;
    const previewContainer = document.getElementById('preview-container');

    avatarInput?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target?.result as string;
          previewImage.classList.remove('hidden');
          previewContainer?.querySelector('svg')?.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</Layout>
