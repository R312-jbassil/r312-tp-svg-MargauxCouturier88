---
import Layout from "../layouts/Layout.astro";

---

<Layout title="G√©n√©rateur">
  <main class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 min-h-[50px]">
    
    <div class="card bg-base-200 shadow-xl p-6 flex flex-col md:col-span-2">
      <h2 class="text-2xl font-bold mb-4 text-primary text-center">üé® Entrer un prompt</h2>
      <textarea 
        class="textarea textarea-bordered w-full mb-4 min-h-[200px]" 
        placeholder="D√©cris ce que tu veux g√©n√©rer..."
      ></textarea>
      <button class="btn btn-primary self-end">üöÄ G√©n√©rer</button>
    </div>

    <div class="flex flex-col gap-6">
      
      <div class="card bg-base-200 shadow-xl p-4">
        <h2 class="text-xl font-semibold mb-2 text-secondary">üíª Code g√©n√©r√©</h2>
        <pre class="bg-black text-green-400 p-3 rounded-lg overflow-auto h-56">
          // Ici s'affichera le code g√©n√©r√©
        </pre>
      </div>

      <div class="card bg-base-200 shadow-xl p-4 flex flex-col items-center">
        <h2 class="text-xl font-semibold mb-2 text-accent">üñºÔ∏è Aper√ßu SVG</h2>
        <div class="w-full h-56 flex items-center justify-center bg-white rounded-lg">
          
        </div>
      </div>
    </div>
  </main>

    <script>
        //@ts-nocheck
        
        async function generateSVG(prompt) {
            console.log('Generating SVG for prompt:', prompt);
            const res = await fetch('/api/generateSVG', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt }),
            });
            const data = await res.json();
            return data.svg;
        }

        async function handleSubmit() {
            let prompt = "";
            let aiResponse = "";
            const promptElement = document.getElementById("user-prompt");
            prompt = promptElement ? promptElement.value : "";
            console.log("submitted: ", prompt);
            // R√©initialiser la liste des prompts
            promptList.length = 0; 
            promptList.push({ role: "user", content: prompt });
            const svgContainer = document.getElementById("svg-container");
            // Afficher un spinner
            svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
            generateButton.disabled = true;
            editButton.disabled = true;
            let svgOutput = document.getElementById("svg-output");
            // Appeler la fonction pour g√©n√©rer le SVG
            aiResponse = await generateSVG(promptList);
            // Extraire le SVG de la r√©ponse
            const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
            aiResponse.content = svgMatch ? svgMatch[0] : "";
            console.log("svgCode: ", aiResponse.content);
            // Ajouter la r√©ponse de l'IA √† la liste des prompts
            promptList.push(aiResponse);
            // Afficher le SVG g√©n√©r√©
            svgOutput.textContent = aiResponse.content;
            svgContainer.innerHTML = aiResponse.content;
            // R√©activer les boutons
            generateButton.disabled = false;
            editButton.disabled = false;
        }
        const generateButton = document.getElementById("generate-button");
        if (generateButton) {
            generateButton.addEventListener("click", handleSubmit);
        }
    </script>

    <script>
        let promptList = [];
        [
    {
        role: 'user',
        content: "",
    },
    {
        role: 'assistant',
        content: ""
    }
]
    </script>

    <button class="btn btn-secondary m-2" id="edit-button">Edit</button>
    
    <script>
    const editButton = document.getElementById("edit-button");

        async function handleEdit() {
            let prompt = "";
            let aiResponse = "";
            const promptElement = document.getElementById("user-prompt");
            prompt = promptElement ? promptElement.value : "";
            console.log("Prompt soumis : ", prompt);
            // Ajout du prompt de l'utilisateur √† la liste
            promptList.push({ role: "user", content: prompt });
            const svgContainer = document.getElementById("svg-container");
            // Afficher un spinner de chargement
            svgContainer.innerHTML += `<span class="loading loading-ring loading-xl"></span>`;
            generateButton.disabled = true;
            editButton.disabled = true;
            let svgOutput = document.getElementById("svg-output");
            // Appeler la fonction pour g√©n√©rer le SVG
            aiResponse = await generateSVG(promptList);
            // Extraire le SVG de la r√©ponse
            const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
            aiResponse.content = svgMatch ? svgMatch[0] : "";
            console.log("Code SVG g√©n√©r√© : ", aiResponse.content);
            // Ajouter la r√©ponse de l'IA √† la liste des prompts
            promptList.push(aiResponse);
            // Afficher le SVG g√©n√©r√©
            svgOutput.textContent = aiResponse.content;
            svgContainer.innerHTML = aiResponse.content;
            // R√©activer les boutons
            generateButton.disabled = false;
            editButton.disabled = false;
            console.log("Historique des prompts : ", promptList);
        }

        if (editButton) {
            editButton.addEventListener("click", handleEdit);
        }
</script>

 <button class="btn btn-secondary m-2" id="save-button">Sauvegarder</button>

 <script>
  const saveButton = document.getElementById("save-button");
    async function saveSVG(params) {
        const res = await fetch("/api/saveSVG", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params),
        });
        const data = await res.json();
        return data;
    }
    if (saveButton) {
        saveButton.addEventListener("click", async () => {
            const name = prompt("Entrez un nom pour le SVG :");
            const svgOutput = document.getElementById("svg-output")?.textContent;
            console.log("Sauvegarde du SVG : ", JSON.stringify(svgOutput));
            
            const params = {
                nom: name,
                code_svg: svgOutput || "<svg></svg>",
                chat_history: JSON.stringify(promptList),
            };
            await saveSVG(params);
        });
    }
 </script>

  <script>
    // Fonction utilitaire pour sauvegarder le SVG
const saveButton = document.getElementById("save-button");

async function saveSVG(params) {
    // Envoi de la requ√™te √† notre endpoint
    const res = await fetch("/api/saveSVG", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(params),
    });
    return await res.json();
}

// Gestionnaire d'√©v√©nements pour le bouton de sauvegarde
if (saveButton) {
    saveButton.addEventListener("click", async () => {
        // Demande du nom du SVG √† l'utilisateur
        const name = prompt("Donnez un nom √† votre cr√©ation :");
        const svgOutput = document.getElementById("svg-output")?.textContent;
        console.log("Pr√©paration de la sauvegarde :", JSON.stringify(svgOutput));
        
        // Pr√©paration des donn√©es pour la sauvegarde
        const params = {
            nom: name,
            code_svg: svgOutput || "<svg></svg>", // SVG par d√©faut si vide
            chat_history: JSON.stringify(promptList), // Historique des √©changes
        };
        
        // Sauvegarde et gestion de la r√©ponse
        const result = await saveSVG(params);
        if (result.success) {
            alert("SVG sauvegard√© avec succ√®s !");
        } else {
            alert("Erreur lors de la sauvegarde : " + result.error);
        }
    });
}
  </script>
</Layout>